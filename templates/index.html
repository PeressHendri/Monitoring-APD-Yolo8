<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Monitoring APD TPS</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #e6f2ff; /* biru muda */
      }
      .container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .header {
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        color: white;
        padding: 16px;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        font-size: 2.2em;
      }
      .header p {
        margin: 4px 0 0;
        font-size: 14px;
      }

      /* area video full width */
      .video-container {
        flex: 1;
        background: #0b1220;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
      }
      .video-stream,
      .skeleton {
        width: 100%;
        height: auto;
        max-height: 75vh;
        border-radius: 10px;
        border: 2px solid #3b82f6;
        object-fit: contain;
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #1e293b 25%,
          #111827 37%,
          #1e293b 63%
        );
        background-size: 400% 100%;
        animation: shimmer 1.4s ease infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 100% 0;
        }
        100% {
          background-position: 0 0;
        }
      }

      /* control panel */
      .controls {
        background: #1e293b;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px 20px;
        align-items: center;
      }
      .controls .btn,
      .controls .history-btn {
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
      }
      .btn-success {
        background: #16a34a;
        color: white;
      }
      .btn-danger {
        background: #dc2626;
        color: white;
      }
      .btn {
        background: #334155;
        color: #e2e8f0;
      }
      .history-btn {
        background: #3b82f6;
        color: white;
        text-decoration: none;
      }
      .controls .btn:hover,
      .history-btn:hover {
        opacity: 0.85;
      }
      #camStatus {
        margin-left: auto;
        font-size: 13px;
        color: #94a3b8;
      }

      /* status grid */
      .status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        padding: 16px 20px;
        background: #0f172a;
      }
      .stat-box {
        text-align: center;
        padding: 14px 10px;
        background: #1e293b;
        border-radius: 10px;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .stat-number {
        font-size: 1.8em;
        font-weight: bold;
        color: #38bdf8;
      }
      .stat-label {
        font-size: 13px;
        color: #cbd5e1;
        margin-top: 4px;
      }

      .footer {
        background: #1e293b;
        padding: 12px;
        text-align: center;
        color: #94a3b8;
      }

      .alarm {
        background: linear-gradient(90deg, #ef4444, #f97316);
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üõ°Ô∏è Sistem Monitoring APD</h1>
        <p>Deteksi Helm & Rompi Real-time</p>
      </div>

      <div class="video-container">
        <div id="placeholder" class="skeleton"></div>
        <img
          id="stream"
          src=""
          class="video-stream"
          alt="Video Stream"
          style="display: none"
          onerror="handleStreamError()"
          onload="handleStreamLoad()" />
      </div>

      <div class="controls">
        <button class="btn btn-success" onclick="startMonitoring()">‚ñ∂Ô∏è Mulai</button>
        <button class="btn btn-danger" onclick="stopMonitoring()">‚èπÔ∏è Henti</button>
        <button class="btn" onclick="resetStats()">üîÑ Reset</button>
        <a href="/history" class="history-btn">üìä Riwayat</a>
        <select id="cameraIndex" class="btn" style="min-width:80px">
          <option value="0">Kamera 0</option>
          <option value="1">Kamera 1</option>
          <option value="2">Kamera 2</option>
        </select>
        <input id="rtspUrl" class="btn" style="min-width:260px" placeholder="RTSP/HTTP URL (opsional)" />
        <button class="btn" onclick="applyCameraSource()">Terapkan</button>
        <label style="color:#cbd5e1; margin-left:8px; font-size:13px">Conf:
          <input id="confSlider" type="range" min="0" max="1" step="0.01" value="0.2" oninput="updateConfLabel(this.value)" onchange="setConf(this.value)" />
          <span id="confLabel">0.20</span>
        </label>
        <label style="color:#cbd5e1; margin-left:8px; font-size:13px">
          <input id="alarmToggle" type="checkbox" checked onchange="toggleAlarmServer(this.checked)" /> Alarm
        </label>
        <span id="camStatus">Menunggu kamera‚Ä¶</span>
      </div>

      <div id="banner" style="display:none; background:#ef4444; color:white; text-align:center; padding:6px 10px;">Gagal membuka kamera.</div>

      <div class="status">
        <div class="stat-box">
          <div class="stat-number" id="helmetCount">0</div>
          <div class="stat-label">Pakai Helm</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="noHelmetCount">0</div>
          <div class="stat-label">Tidak Pakai Helm</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="vestCount">0</div>
          <div class="stat-label">Pakai Rompi</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="noVestCount">0</div>
          <div class="stat-label">Tidak Pakai Rompi</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="violations">0</div>
          <div class="stat-label">Total Pelanggaran</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="fps">0</div>
          <div class="stat-label">FPS / ms</div>
        </div>
      </div>

      <div class="footer">¬© 2025 Sistem Monitoring APD</div>
    </div>

    <script>
      let updateInterval;
      let soundEnabled = false; // gunakan suara dari server (alarm.wav)
      let reconnectDelay = 1000;

      function startMonitoring() {
        setCamStatus("Menghidupkan kamera‚Ä¶");
        fetch("/api/start")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              startStatusUpdates();
              showMessage("Monitoring dimulai!", "success");
              setCamStatus("Kamera aktif");
              startStream();
            } else {
              showMessage("Gagal memulai monitoring: " + data.message, "error");
              setCamStatus("Gagal menghidupkan kamera");
            }
          });
      }

      function stopMonitoring() {
        fetch("/api/stop")
          .then((response) => response.json())
          .then((data) => {
            stopStatusUpdates();
            showMessage("Monitoring dihentikan!", "info");
            setCamStatus("Kamera mati");
            stopStream();
          });
      }

      function resetStats() {
        fetch("/api/reset")
          .then((response) => response.json())
          .then((data) => {
            showMessage("Statistik direset!", "info");
            updateStatus();
          });
      }

      function startStatusUpdates() {
        updateInterval = setInterval(updateStatus, 1000);
      }

      function stopStatusUpdates() {
        if (updateInterval) {
          clearInterval(updateInterval);
        }
      }

      function updateStatus() {
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("helmetCount").textContent =
              data.helmet_count;
            document.getElementById("noHelmetCount").textContent =
              data.no_helmet_count;
            document.getElementById("vestCount").textContent = data.vest_count;
            document.getElementById("noVestCount").textContent =
              data.no_vest_count;
            document.getElementById("violations").textContent =
              data.total_violations;
            // FPS and inference time
            const fpsText = `${data.fps || 0} / ${data.inference_ms || 0}`;
            const fpsEl = document.getElementById('fps');
            if (fpsEl) fpsEl.textContent = fpsText;

            // sync UI state from server (once available)
            const confEl = document.getElementById('confSlider');
            const confLabel = document.getElementById('confLabel');
            if (confEl && typeof data.conf_threshold === 'number') {
              confEl.value = data.conf_threshold;
              updateConfLabel(data.conf_threshold);
            }
            const alarmToggle = document.getElementById('alarmToggle');
            if (alarmToggle && typeof data.alarm_enabled === 'boolean') {
              alarmToggle.checked = data.alarm_enabled;
            }

            // Banner error kamera
            const banner = document.getElementById('banner');
            if (banner) {
              if (data.camera_error || (data.camera_attempts && !data.is_running)) {
                banner.style.display = 'block';
                banner.textContent = `Gagal membuka kamera. Dicoba: ${data.camera_attempts || '-'} ${data.camera_error ? '('+data.camera_error+')' : ''}`;
              } else {
                banner.style.display = 'none';
              }
            }

            // Tampilkan alarm jika ada pelanggaran (suara diputar oleh server)
            if (data.no_helmet_count > 0 || data.no_vest_count > 0) {
              showAlarm();
            } else {
              hideAlarm();
            }
          });
      }

      function applyCameraSource() {
        const idx = document.getElementById('cameraIndex').value;
        const url = document.getElementById('rtspUrl').value.trim();
        const source = url.length > 0 ? url : idx;
        fetch('/api/set_camera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source })
        }).then(r => r.json()).then(data => {
          if (data.status === 'success') {
            showMessage('Sumber kamera diterapkan', 'success');
            setCamStatus('Kamera aktif');
            startStream();
          } else {
            showMessage('Gagal set sumber kamera', 'error');
            setCamStatus('Gagal set kamera');
          }
        });
      }

      function updateConfLabel(v) {
        const el = document.getElementById('confLabel');
        if (el) el.textContent = Number(v).toFixed(2);
      }

      function setConf(v) {
        fetch('/api/set_conf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conf_threshold: Number(v) })
        }).then(r => r.json()).then(data => {
          if (data.status !== 'success') {
            showMessage('Gagal set threshold', 'error');
          }
        });
      }

      function toggleAlarmServer(enabled) {
        fetch('/api/set_alarm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        }).then(r => r.json()).then(data => {
          if (data.status !== 'success') {
            showMessage('Gagal set alarm', 'error');
          }
        });
      }

      function startStream() {
        const img = document.getElementById("stream");
        const ph = document.getElementById("placeholder");
        if (img) {
          img.style.display = "block";
          if (ph) ph.style.display = "none";
          img.src = "{{ url_for('video_feed') }}?t=" + Date.now();
        }
      }

      function stopStream() {
        const img = document.getElementById("stream");
        const ph = document.getElementById("placeholder");
        if (img) {
          img.removeAttribute("src");
          img.style.display = "none";
        }
        if (ph) ph.style.display = "block";
      }

      function handleStreamError() {
        setCamStatus("Gagal memuat stream, mencoba ulang‚Ä¶");
        const img = document.getElementById("stream");
        if (!img) return;
        setTimeout(() => {
          img.src = "{{ url_for('video_feed') }}?t=" + Date.now();
          reconnectDelay = Math.min(reconnectDelay * 1.5, 4000);
        }, reconnectDelay);
      }

      function handleStreamLoad() {
        reconnectDelay = 1000;
      }

      function setCamStatus(text) {
        const el = document.getElementById("camStatus");
        if (el) el.textContent = text;
      }

      function showAlarm() {
        let alarm = document.getElementById("alarm");
        if (!alarm) {
          alarm = document.createElement("div");
          alarm.id = "alarm";
          alarm.className = "alarm";
          alarm.innerHTML = "üö® ALARM! PELANGGARAN APD DETECTED! üö®";
          document.body.insertBefore(alarm, document.body.firstChild);
        }
        // Suara alarm diputar di server (alarm.wav). Browser tidak memutar suara lokal.
      }

      function hideAlarm() {
        let alarm = document.getElementById("alarm");
        if (alarm) {
          alarm.remove();
        }
      }

      // Tidak ada suara lokal; server yang memutar alarm.wav

      function toggleSound() {
        soundEnabled = !soundEnabled;
        const btn = document.getElementById("soundToggle");
        if (soundEnabled) {
          btn.textContent = "üîä Suara ON";
          btn.classList.add("active");
        } else {
          btn.textContent = "üîá Suara OFF";
          btn.classList.remove("active");
        }
      }

      // Test alarm dinonaktifkan (suara dikelola server)

      function showMessage(message, type) {
        // Tampilkan pesan sederhana
        console.log(type.toUpperCase() + ":", message);
      }

      // Mulai update status saat halaman dimuat
      window.onload = function () {
        startMonitoring();
        startStatusUpdates();
      };

      // Hentikan update saat halaman ditutup
      window.onbeforeunload = function () {
        stopStatusUpdates();
      };
    </script>
  </body>
</html>
